name: Auto Update Blog with AI

on:
  schedule:
    - cron: '0 0,6,12 * * *'
  workflow_dispatch:
    inputs:
      enable_ai:
        description: 'AI ì½˜í…ì¸  ìƒì„± í™œì„±í™”' 
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-blog:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ðŸ Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd automation
        pip install -r requirements.txt
        
    - name: âœï¸ Step 1 - ì£¼ì œ ì„ ì •
      if: ${{ github.event.inputs.enable_ai != 'false' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
      run: |
        echo "ðŸŽ¯ Step 1: ë¸”ë£¨ì˜¤ì…˜ í‚¤ì›Œë“œ ë°œêµ´ ì¤‘..."
        python automation/step1_topic_agent.py
    
    - name: ðŸ“ Step 2 - ê¸€ ìž‘ì„±
      if: ${{ github.event.inputs.enable_ai != 'false' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
      run: |
        echo "ðŸ“ Step 2: êµ¬ì¡°í™”ëœ ì½˜í…ì¸  ìž‘ì„± ì¤‘..."
        python automation/step2_writer_agent.py
    
    - name: ðŸŽ¨ Step 3 - ì´ë¯¸ì§€ ìƒì„± ë° ê²€ìˆ˜
      if: ${{ github.event.inputs.enable_ai != 'false' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
        HUGGINGFACE_API_TOKEN: ${{ secrets.HUGGINGFACE_API_TOKEN }}
      run: |
        echo "ðŸŽ¨ Step 3: ì´ë¯¸ì§€ ìƒì„± ë° Gemini Vision ê²€ìˆ˜ ì¤‘..."
        python automation/step3_image_audit_agent.py
    
    - name: ðŸ’¾ Step 4 - data.json ì €ìž¥
      if: ${{ github.event.inputs.enable_ai != 'false' }}
      run: |
        echo "ðŸ’¾ Step 4: data.json ë° Markdown íŒŒì¼ ìƒì„± ì¤‘..."
        python automation/step4_save_to_data_json.py
        
    - name: ðŸ”¨ ë¸”ë¡œê·¸ ë¹Œë“œ
      run: |
        echo "ðŸ”¨ build_blog.py ì‹¤í–‰ ì¤‘..."
        python automation/build_blog.py
        echo "âœ… ë¸”ë¡œê·¸ ë¹Œë“œ ì™„ë£Œ"
    
    - name: ðŸ“Š data.json ì´ë™
      run: |
        if [ -f automation/data.json ]; then
          cp automation/data.json data.json
          echo "âœ… data.json ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        else
          echo "âŒ data.json ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: ðŸ“‹ ê²€ìˆ˜ìš© PR ìƒì„±
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add data.json data/ feed/ contents/ automation/generated_images/ automation/intermediate_outputs/
        
        if ! git diff --staged --quiet; then
          BRANCH_NAME="ai-review-$(date +'%Y%m%d-%H%M%S')"
          TOPIC=$(cat automation/intermediate_outputs/step1_topic.json | jq -r '.title' || echo "AI ìƒì„± í¬ìŠ¤íŠ¸")
          
          git checkout -b $BRANCH_NAME
          git commit -m "ðŸ¤– [ê²€ìˆ˜ ìš”ì²­] $TOPIC"
          git push origin $BRANCH_NAME
          
          cat > /tmp/pr_body.md << 'EOF'
## ðŸ“ AIê°€ ìƒˆë¡œìš´ í¬ìŠ¤íŒ…ì„ ìž‘ì„±í–ˆìŠµë‹ˆë‹¤

**ìž‘ì„± ì‹œê°:** ìžë™ ìƒì„±

---

### âœ… ê²€ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì´ë¯¸ì§€ í™•ì¸ (automation/generated_images/)
- [ ] ì´ë¯¸ì§€ê°€ ì£¼ì œì™€ ë§žëŠ”ì§€ í™•ì¸
- [ ] ë‚´ìš© í™•ì¸ (contents/*.md)
- [ ] ì˜¤íƒ€ ë° ë¬¸ë²• í™•ì¸

### ðŸ“Œ ë‹¤ìŒ ë‹¨ê³„
1. **ìŠ¹ì¸:** Merge pull request ë²„íŠ¼ í´ë¦­
2. **ìˆ˜ì •:** Files changed íƒ­ì—ì„œ ìˆ˜ì •
3. **ê±°ë¶€:** Close pull request

### ðŸ”§ ë¬¸ì œ ë°œê²¬ ì‹œ
- ì´ë¯¸ì§€ ì´ìƒ: PR ë‹«ê³  ìž¬ì‹¤í–‰
- ë‚´ìš© ìˆ˜ì •: Files changedì—ì„œ ìˆ˜ì •

---

ë¯¸ë¦¬ë³´ê¸°: Files changed íƒ­ì—ì„œ ì´ë¯¸ì§€ í´ë¦­
EOF
          
          gh pr create \
            --title "ðŸ¤– [ê²€ìˆ˜ ìš”ì²­] $TOPIC" \
            --body-file /tmp/pr_body.md \
            --base main \
            --head $BRANCH_NAME \
            --label "ai-generated,needs-review"
          
          echo "âœ… PR ìƒì„± ì™„ë£Œ: $BRANCH_NAME"
          echo "ðŸ“± ëª¨ë°”ì¼ì—ì„œ GitHub ì•Œë¦¼ í™•ì¸í•˜ì„¸ìš”!"
        else
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi
