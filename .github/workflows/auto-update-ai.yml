name: Auto Update Blog with AI

on:
  schedule:
    - cron: '0 0,6,12 * * *' # ë§¤ì¼ 09:00, 15:00, 21:00 KST
  workflow_dispatch:
    inputs:
      enable_ai:
        description: 'AI ì½˜í…ì¸  ìƒì„± í™œì„±í™”'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-blog:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }} # íŒŒì´ì¬ ê²½ë¡œ ëª…ì‹œ

    steps:
    - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ðŸ Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd automation
        pip install -r requirements.txt
        
    - name: âœï¸ Step 1 - ì£¼ì œ ì„ ì •
      if: ${{ github.event_name == 'schedule' || github.event.inputs.enable_ai != 'false' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
      run: |
        echo "ðŸŽ¯ Step 1: ë¸”ë£¨ì˜¤ì…˜ í‚¤ì›Œë“œ ë°œêµ´ ì¤‘..."
        python automation/step1_topic_agent.py
    
    - name: ðŸ“ Step 2 - ê¸€ ìž‘ì„±
      if: ${{ github.event_name == 'schedule' || github.event.inputs.enable_ai != 'false' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
      run: |
        echo "ðŸ“ Step 2: êµ¬ì¡°í™”ëœ ì½˜í…ì¸  ìž‘ì„± ì¤‘..."
        python automation/step2_writer_agent.py
    
    - name: ðŸŽ¨ Step 3 - ì´ë¯¸ì§€ ìƒì„± ë° ê²€ìˆ˜
      if: ${{ github.event_name == 'schedule' || github.event.inputs.enable_ai != 'false' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
        HUGGINGFACE_API_TOKEN: ${{ secrets.HUGGINGFACE_API_TOKEN }} 
      run: |
        echo "ðŸŽ¨ Step 3: ì´ë¯¸ì§€ ìƒì„± ë° Gemini Vision ê²€ìˆ˜ ì¤‘..."
        python automation/step3_image_audit_agent.py
    
    - name: ðŸ’¾ Step 4 - data.json ì €ìž¥
      if: ${{ github.event_name == 'schedule' || github.event.inputs.enable_ai != 'false' }}
      run: |
        echo "ðŸ’¾ Step 4: data.json ë° Markdown íŒŒì¼ ìƒì„± ì¤‘..."
        python automation/step4_save_to_data_json.py
        
    - name: ðŸ”¨ ë¸”ë¡œê·¸ ë¹Œë“œ (RSS/HTML)
      run: |
        echo "ðŸ”¨ build_blog.py ì‹¤í–‰ ì¤‘..."
        python automation/build_blog.py
        echo "âœ… ë¸”ë¡œê·¸ ë¹Œë“œ ì™„ë£Œ"
    
    - name: ðŸ“Š data.json ì´ë™
      run: |
        if [ -f automation/data.json ]; then
          cp automation/data.json data.json
          echo "âœ… data.json ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        else
          echo "âŒ data.json ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: ðŸ“‹ ê²€ìˆ˜ìš© PR ìƒì„±
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TZ: 'Asia/Seoul'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # [ì•ˆì „ìž¥ì¹˜] íŒŒì¼ì´ ì¡´ìž¬í•  ë•Œë§Œ add (ì—ëŸ¬ ë°©ì§€)
        git add data.json || true
        git add contents/ || true
        git add automation/generated_images/ || true
        git add feed/ || true
        
        if ! git diff --staged --quiet; then
          CURRENT_DATE=$(date +'%Y%m%d-%H%M%S')
          BRANCH_NAME="ai-review-$CURRENT_DATE"
          
          if [ -f automation/intermediate_outputs/step1_topic.json ]; then
            TOPIC=$(cat automation/intermediate_outputs/step1_topic.json | jq -r '.title')
          else
            TOPIC="AI ìžë™ ìƒì„± í¬ìŠ¤íŠ¸ ($CURRENT_DATE)"
          fi
          
          git checkout -b $BRANCH_NAME
          git commit -m "ðŸ¤– [ê²€ìˆ˜ ìš”ì²­] $TOPIC"
          git push origin $BRANCH_NAME
          
          cat > /tmp/pr_body.md << EOF
          ## ðŸ“ AIê°€ ìƒˆë¡œìš´ í¬ìŠ¤íŒ…ì„ ìž‘ì„±í–ˆìŠµë‹ˆë‹¤
          
          **ì£¼ì œ:** $TOPIC
          **ìž‘ì„± ì‹œê°:** $(date +'%Y-%m-%d %H:%M:%S') (KST)
          
          ---
          
          ### âœ… ê²€ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
          - [ ] **ì´ë¯¸ì§€:** \`automation/generated_images/\` í´ë” í™•ì¸
          - [ ] **ë‚´ìš©:** \`contents/\` í´ë”ì˜ Markdown íŒŒì¼ í™•ì¸
          - [ ] **ë©”íƒ€ë°ì´í„°:** \`data.json\` ì—…ë°ì´íŠ¸ í™•ì¸
          
          ### ðŸ“Œ ê´€ë¦¬ìž í–‰ë™ ê°€ì´ë“œ
          1. **ìŠ¹ì¸:** [Merge pull request] í´ë¦­ â†’ ë°°í¬
          2. **ìˆ˜ì •:** [Files changed] íƒ­ â†’ Edit file â†’ ìˆ˜ì •
          3. **ë°˜ë ¤:** [Close pull request] í´ë¦­ â†’ íê¸°
          
          ---
          ðŸ¤– *This content was generated by Gemini AI Pipeline.*
          EOF
          
          gh pr create \
            --title "ðŸ¤– [ê²€ìˆ˜ ìš”ì²­] $TOPIC" \
            --body-file /tmp/pr_body.md \
            --base main \
            --head $BRANCH_NAME \
            --label "ai-generated" \
            --label "needs-review"
          
          echo "âœ… PR ìƒì„± ì™„ë£Œ: $BRANCH_NAME"
        else
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi

    - name: ðŸ“¤ (ì‹¤íŒ¨ ì‹œ) ë””ë²„ê¹…ìš© íŒŒì¼ ì—…ë¡œë“œ
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-logs
        path: automation/intermediate_outputs/
        retention-days: 3