name: Auto Update Blog with AI

on:
  schedule:
    - cron: '0 0,6,12 * * *'
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'ì œëª©/ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë¹„ì›Œë‘ë©´ AIê°€ ìë™ ì„ ì •)'
        required: false  # [ì¤‘ìš”] falseë¡œ ë³€ê²½í•´ì•¼ ë¹ˆì¹¸ ì‹¤í–‰ ê°€ëŠ¥
        type: string
      manual_content:
        description: 'ë³¸ë¬¸ ë‚´ìš© (ë¹„ì›Œë‘ë©´ AI ì°½ì‘, ì…ë ¥í•˜ë©´ AIê°€ ì •ë¦¬+ì´ë¯¸ì§€ ì¶”ê°€)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-blog:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}

    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd automation
        pip install -r requirements.txt
        
    # [Step 1] ì£¼ì œ ì„¤ì • (ìˆ˜ë™ ì…ë ¥ ì—†ìœ¼ë©´ ìë™ ì„ ì •)
    - name: ğŸš€ Step 1 - ì£¼ì œ ì„ ì •
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        MANUAL_TOPIC: ${{ github.event.inputs.manual_topic }}
      run: |
        mkdir -p automation/intermediate_outputs
        # ì œëª© ì…ë ¥ì´ ì—†ìœ¼ë©´(-z) ìë™ ëª¨ë“œ ì‹¤í–‰
        if [[ -z "$MANUAL_TOPIC" ]]; then
           echo "ğŸ¤– ì£¼ì œ ìë™ ì„ ì • ëª¨ë“œ (ì…ë ¥ê°’ ì—†ìŒ)"
           python automation/step1_topic_agent.py
        else
           echo "ğŸ“ ìˆ˜ë™ ì£¼ì œ ëª¨ë“œ: $MANUAL_TOPIC"
           # íŒŒì´ì¬ìœ¼ë¡œ topic.json ê°•ì œ ìƒì„±
           python3 -c "import json; import os; topic = os.environ['MANUAL_TOPIC']; data = {'title': topic, 'search_keywords': [topic]}; print(json.dumps(data, ensure_ascii=False))" > automation/intermediate_outputs/step1_topic.json
        fi

    # [Step 2] ê¸€ ì‘ì„± (ì—ë””í„° ëª¨ë“œ vs ì°½ì‘ ëª¨ë“œ)
    - name: ğŸ“ Step 2 - ê¸€ ì‘ì„± (Editor Mode)
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
        # ë³¸ë¬¸ ë‚´ìš©ì´ ìˆìœ¼ë©´ í™˜ê²½ë³€ìˆ˜ë¡œ ì „ë‹¬
        MANUAL_CONTENT: ${{ github.event.inputs.manual_content }}
      run: |
        echo "ğŸ“ Step 2 ì‹¤í–‰..."
        python automation/step2_writer_agent.py

    # [Step 3] ì´ë¯¸ì§€ ìƒì„±
    - name: ğŸ¨ Step 3 - ì´ë¯¸ì§€ ìƒì„± ë° ê²€ìˆ˜
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
        HUGGINGFACE_API_TOKEN: ${{ secrets.HUGGINGFACE_API_TOKEN }} 
      run: python automation/step3_image_audit_agent.py
    
    # [Step 4] ì €ì¥
    - name: ğŸ’¾ Step 4 - data.json ì €ì¥
      run: python automation/step4_save_to_data_json.py
        
    - name: ğŸ”¨ ë¸”ë¡œê·¸ ë¹Œë“œ (RSS/HTML)
      run: python automation/build_blog.py
    
    - name: ğŸ“Š data.json ì´ë™
      run: cp automation/data.json data.json || exit 1
        
    - name: ğŸ“‹ ê²€ìˆ˜ìš© PR ìƒì„±
      env:
        GH_TOKEN: ${{ secrets.MY_PAT }} 
        TZ: 'Asia/Seoul'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .
        if ! git diff --staged --quiet; then
          CURRENT_DATE=$(date +'%Y%m%d-%H%M%S')
          BRANCH_NAME="ai-content-$CURRENT_DATE"
          if [ -f automation/intermediate_outputs/step1_topic.json ]; then
            TOPIC=$(cat automation/intermediate_outputs/step1_topic.json | jq -r '.title')
          else
            TOPIC="AI í¬ìŠ¤íŒ…"
          fi
          git checkout -b $BRANCH_NAME
          git commit -m "ğŸ“ [AI ì‘ì„±] $TOPIC"
          git push origin $BRANCH_NAME
          gh pr create --title "ğŸ“ [AI ì‘ì„±] $TOPIC" --body "AIê°€ ì‘ì„±í•œ ìƒˆ ê¸€ì…ë‹ˆë‹¤." --base main --head $BRANCH_NAME
        fi